worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # DNS for Docker services
    resolver 127.0.0.11 valid=10s;

    log_format custom_main '$remote_addr - $remote_user [$time_local] "$request" '
                           '$status $body_bytes_sent "$http_referer" '
                           '"$http_user_agent" "$http_x_forwarded_for" '
                           'rt=$request_time urt=$upstream_response_time';

    access_log /var/log/nginx/access.log custom_main;
    error_log /var/log/nginx/error.log warn;

    server {
        listen 80;
        server_name localhost;
        client_max_body_size 15m;

        # ===============================
        # HEALTH CHECK
        # ===============================
        location /health {
            access_log off;
            add_header Content-Type application/json;
            return 200 '{"status":"ok","service":"nginx-gateway"}';
        }

        # ===============================
        # COMMON HEADERS
        # ===============================
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ===============================
        # AUTH SERVICE
        # ===============================
        location /api/auth/ {
            rewrite ^/api/auth/?(.*)$ /$1 break;
            proxy_pass http://auth-service:3001;
        }

        # ===============================
        # USER SERVICE
        # ===============================
        location /api/users/ {
            rewrite ^/api/users/?(.*)$ /users/$1 break;
            proxy_pass http://user-service:3002;
        }

        # ===============================
        # ADMIN SERVICE
        # ===============================
        location /api/admin/ {
            rewrite ^/api/admin/?(.*)$ /$1 break;
            proxy_pass http://admin-service:3003;
        }

        # ===============================
        # MEAL SERVICE - COMMENTED OUT (SERVICE NOT RUNNING)
        # ===============================
        # location ^~ /api/meals/ {
        #     # /api/meals/status  -> /meals/status
        #     rewrite ^/api/meals/?(.*)$ /meals/$1 break;
        #     proxy_pass http://meal-service:3004;
        # }

        # ===============================
        # NUTRITION (MEAL SERVICE) - COMMENTED OUT (SERVICE NOT RUNNING)
        # ===============================
        # location /api/nutrition/ {
        #     rewrite ^/api/nutrition/?(.*)$ /nutrition/$1 break;
        #     proxy_pass http://meal-service:3004;
        # }

        # ===============================
        # GOAL SERVICE
        # ===============================
        location ^~ /api/goals {
            rewrite ^/api/goals/?(.*)$ /goals/$1 break;
            proxy_pass http://goal-service:3006;
        }

        # ===============================
        # RECOMMENDATION SERVICE - COMMENTED OUT (SERVICE NOT RUNNING)
        # ===============================
        # location /api/recommendations/ {
        #     rewrite ^/api/recommendations/?(.*)$ /recommendations/$1 break;
        #     proxy_pass http://recommendation-service:3007;
        # }

        # ===============================
        # PAYMENT SERVICE - COMMENTED OUT (SERVICE NOT RUNNING)
        # ===============================
        # location /api/payments/ {
        #     rewrite ^/api/payments/?(.*)$ /payments/$1 break;
        #     proxy_pass http://payment-service:3008;
        # }

        # ===============================
        # REDIRECT WHEN MISSING SLASH (ONLY FOR ACTIVE SERVICES)
        # ===============================
        # location = /api/meals { return 301 /api/meals/; }
        location = /api/auth { return 301 /api/auth/; }
        location = /api/users { return 301 /api/users/; }
        location = /api/admin { return 301 /api/admin/; }
        location = /api/goals {
            rewrite ^ /api/goals/ last;
        }
        # location = /api/recommendations { return 301 /api/recommendations/; }

        # ===============================
        # DEFAULT
        # ===============================
        location / {
            add_header Content-Type application/json;
            return 404 '{"error":"API endpoint not found"}';
        }
    }
}
