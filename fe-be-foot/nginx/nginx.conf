upstream auth_service { server auth-service:3001; }
upstream user_service { server user-service:3002; }
upstream admin_service { server admin-service:3003; }

server {
    listen 80;  # Docker exposes 3000->80, so listen on 80 inside container

    # (tuỳ chọn) set header chung
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # API routes
    location /api/auth/ {
        proxy_pass http://auth_service/;
    }

    location /api/user/ {
        proxy_pass http://user_service/;
    }

    location /api/admin/ {
        proxy_pass http://admin_service/;
    }

    # Admin dashboard route
    location /dashboard {
        proxy_pass http://admin_service/dashboard;
    }

    # Match cả /api/user (không slash) → redirect về /api/user/
    location = /api/auth { return 301 /api/auth/; }
    location = /api/user { return 301 /api/user/; }
    location = /api/admin { return 301 /api/admin/; }

    # Default response cho route không khớp
    default_type application/json;
    location / {
        return 404 '{"error":"API endpoint not found"}';
    }
}
